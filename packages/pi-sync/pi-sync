#!/usr/bin/env bash
#
# pi-sync - Sync skillz repository to ~/.pi/agent/
#
# Usage:
#   pi-sync [OPTIONS] [COMMAND] [ITEMS...]
#
# Commands:
#   extensions [NAMES...]  Sync extensions (all if no names given)
#   skills [NAMES...]      Sync skills (all if no names given)
#   config                 Sync config files (AGENTS.md from pi/)
#   all                    Sync everything
#   list                   List available extensions, skills, and config
#   status                 Show what's currently synced
#
# Options:
#   -c, --copy      Copy files instead of symlinking
#   -f, --force     Overwrite existing files
#   -n, --dry-run   Show what would be done without doing it
#   -q, --quiet     Suppress output
#   -h, --help      Show this help
#
# Environment:
#   SKILLZ_DIR      Path to skillz repository (default: auto-detect)
#   PI_AGENT_DIR    Path to pi agent config (default: ~/.pi/agent)

set -euo pipefail

# ─── Colors ───────────────────────────────────────────────────────────────────

if [[ -t 1 ]]; then
    RED='\033[0;31m'
    GREEN='\033[0;32m'
    YELLOW='\033[0;33m'
    BLUE='\033[0;34m'
    BOLD='\033[1m'
    NC='\033[0m'
else
    RED=''
    GREEN=''
    YELLOW=''
    BLUE=''
    BOLD=''
    NC=''
fi

# ─── Defaults ─────────────────────────────────────────────────────────────────

USE_SYMLINK=true
FORCE=false
DRY_RUN=false
QUIET=false

# Auto-detect skillz directory (script location or SKILLZ_DIR)
if [[ -n "${SKILLZ_DIR:-}" ]]; then
    : # SKILLZ_DIR already set
elif [[ -L "${BASH_SOURCE[0]}" ]]; then
    # Script is a symlink, resolve it
    SCRIPT_PATH="$(readlink -f "${BASH_SOURCE[0]}")"
    SKILLZ_DIR="$(cd "$(dirname "$SCRIPT_PATH")/../.." && pwd)"
else
    SKILLZ_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/../.." && pwd)"
fi

PI_AGENT_DIR="${PI_AGENT_DIR:-$HOME/.pi/agent}"

# ─── Helpers ──────────────────────────────────────────────────────────────────

log() {
    if [[ "$QUIET" != true ]]; then
        echo -e "$*"
    fi
}

error() {
    echo -e "${RED}error:${NC} $*" >&2
}

warn() {
    echo -e "${YELLOW}warning:${NC} $*" >&2
}

die() {
    error "$@"
    exit 1
}

# ─── Core Functions ───────────────────────────────────────────────────────────

list_extensions() {
    local ext_dir="$SKILLZ_DIR/pi/extensions"
    if [[ ! -d "$ext_dir" ]]; then
        return
    fi

    # Find .ts files directly or in subdirectories, excluding node_modules and .d.ts files
    find "$ext_dir" -path "*/node_modules" -prune -o -name "*.ts" ! -name "*.d.ts" -type f -print 2>/dev/null | while read -r file; do
        local rel="${file#"$ext_dir/"}"
        local name
        if [[ "$rel" == */* ]]; then
            # In subdirectory: use directory name
            name="$(dirname "$rel")"
        else
            # Direct file: use filename without extension
            name="${rel%.ts}"
        fi
        echo "$name"
    done | sort -u
}

list_skills() {
    local skills_dir="$SKILLZ_DIR/skills"
    if [[ ! -d "$skills_dir" ]]; then
        return
    fi

    # Find directories containing SKILL.md
    find "$skills_dir" -name "SKILL.md" -type f 2>/dev/null | while read -r file; do
        local dir
        dir="$(dirname "$file")"
        local rel="${dir#"$skills_dir/"}"
        # Get top-level skill name
        echo "$rel" | cut -d'/' -f1
    done | sort -u
}

get_extension_source() {
    local name="$1"
    local ext_dir="$SKILLZ_DIR/pi/extensions"

    # Check for directory with .ts file (exclude .d.ts files)
    if [[ -d "$ext_dir/$name" ]]; then
        local ts_file
        ts_file="$(find "$ext_dir/$name" -maxdepth 1 -name "*.ts" ! -name "*.d.ts" -type f | head -1)"
        if [[ -n "$ts_file" ]]; then
            # Return directory path if it has dependencies (package.json)
            if [[ -f "$ext_dir/$name/package.json" ]]; then
                echo "$ext_dir/$name:dir"
            else
                echo "$ts_file:file"
            fi
            return 0
        fi
    fi

    # Check for direct .ts file
    if [[ -f "$ext_dir/$name.ts" ]]; then
        echo "$ext_dir/$name.ts:file"
        return 0
    fi

    return 1
}

get_skill_source() {
    local name="$1"
    local skills_dir="$SKILLZ_DIR/skills"

    if [[ -d "$skills_dir/$name" ]]; then
        echo "$skills_dir/$name"
        return 0
    fi

    return 1
}

sync_file() {
    local src="$1"
    local dst="$2"
    local type="$3"

    # Create parent directory
    local dst_dir
    dst_dir="$(dirname "$dst")"

    if [[ "$DRY_RUN" == true ]]; then
        if [[ "$USE_SYMLINK" == true ]]; then
            log "  ${BLUE}[dry-run]${NC} symlink $dst -> $src"
        else
            log "  ${BLUE}[dry-run]${NC} copy $src -> $dst"
        fi
        return 0
    fi

    mkdir -p "$dst_dir"

    # Handle existing file/symlink
    if [[ -e "$dst" || -L "$dst" ]]; then
        if [[ "$FORCE" == true ]]; then
            rm -rf "$dst"
        else
            warn "exists: $dst (use --force to overwrite)"
            return 1
        fi
    fi

    if [[ "$USE_SYMLINK" == true ]]; then
        ln -s "$src" "$dst"
        log "  ${GREEN}symlinked${NC} $type: $(basename "$dst")"
    else
        if [[ -d "$src" ]]; then
            cp -r "$src" "$dst"
        else
            cp "$src" "$dst"
        fi
        log "  ${GREEN}copied${NC} $type: $(basename "$dst")"
    fi
}

sync_extensions() {
    local items=("$@")
    local ext_dir="$PI_AGENT_DIR/extensions"

    log "${BOLD}Syncing extensions...${NC}"

    if [[ ${#items[@]} -eq 0 ]]; then
        mapfile -t items < <(list_extensions)
    fi

    if [[ ${#items[@]} -eq 0 ]]; then
        warn "no extensions found"
        return 0
    fi

    local count=0
    for name in "${items[@]}"; do
        local src_info
        if ! src_info="$(get_extension_source "$name")"; then
            warn "extension not found: $name"
            continue
        fi

        local src="${src_info%:*}"
        local src_type="${src_info##*:}"

        if [[ "$src_type" == "dir" ]]; then
            # Extension with dependencies - sync directory
            if sync_extension_dir "$src" "$ext_dir/$name" "$name"; then
                ((count++)) || true
            fi
        else
            # Simple extension - sync single file
            local dst="$ext_dir/$(basename "$src")"
            if sync_file "$src" "$dst" "extension"; then
                ((count++)) || true
            fi
        fi
    done

    log "  ${BOLD}$count${NC} extension(s) synced"
}

sync_extension_dir() {
    local src_dir="$1"
    local dst_dir="$2"
    local name="$3"

    if [[ "$DRY_RUN" == true ]]; then
        if [[ "$USE_SYMLINK" == true ]]; then
            log "  ${BLUE}[dry-run]${NC} symlink $dst_dir -> $src_dir"
        else
            log "  ${BLUE}[dry-run]${NC} copy $src_dir -> $dst_dir (+ npm install)"
        fi
        return 0
    fi

    # Handle existing
    if [[ -e "$dst_dir" || -L "$dst_dir" ]]; then
        if [[ "$FORCE" == true ]]; then
            rm -rf "$dst_dir"
        else
            warn "exists: $dst_dir (use --force to overwrite)"
            return 1
        fi
    fi

    mkdir -p "$(dirname "$dst_dir")"

    if [[ "$USE_SYMLINK" == true ]]; then
        ln -s "$src_dir" "$dst_dir"
        log "  ${GREEN}symlinked${NC} extension: $name/"
    else
        # Copy directory excluding node_modules
        mkdir -p "$dst_dir"
        find "$src_dir" -maxdepth 1 -type f \( -name "*.ts" -o -name "package.json" -o -name "package-lock.json" -o -name ".gitignore" \) ! -name "*.d.ts" -exec cp {} "$dst_dir/" \;

        # Run npm install if package.json exists
        if [[ -f "$dst_dir/package.json" ]]; then
            log "  ${YELLOW}installing${NC} dependencies for $name..."
            if ! (cd "$dst_dir" && npm install --silent 2>/dev/null); then
                warn "npm install failed for $name"
                return 1
            fi
        fi
        log "  ${GREEN}copied${NC} extension: $name/"
    fi

    return 0
}

sync_skills() {
    local items=("$@")
    local skills_dir="$PI_AGENT_DIR/skills"

    log "${BOLD}Syncing skills...${NC}"

    if [[ ${#items[@]} -eq 0 ]]; then
        mapfile -t items < <(list_skills)
    fi

    if [[ ${#items[@]} -eq 0 ]]; then
        warn "no skills found"
        return 0
    fi

    local count=0
    for name in "${items[@]}"; do
        local src
        if ! src="$(get_skill_source "$name")"; then
            warn "skill not found: $name"
            continue
        fi

        local dst="$skills_dir/$name"
        if sync_file "$src" "$dst" "skill"; then
            ((count++)) || true
        fi
    done

    log "  ${BOLD}$count${NC} skill(s) synced"
}

sync_config() {
    log "${BOLD}Syncing config...${NC}"

    local count=0
    local pi_dir="$SKILLZ_DIR/pi"

    # Sync AGENTS.md from pi/ if it exists
    if [[ -f "$pi_dir/AGENTS.md" ]]; then
        local src="$pi_dir/AGENTS.md"
        local dst="$PI_AGENT_DIR/AGENTS.md"
        if sync_file "$src" "$dst" "config"; then
            ((count++)) || true
        fi
    else
        log "  no AGENTS.md found in pi/"
    fi

    # Sync SYSTEM.md from pi/ if it exists
    if [[ -f "$pi_dir/SYSTEM.md" ]]; then
        local src="$pi_dir/SYSTEM.md"
        local dst="$PI_AGENT_DIR/SYSTEM.md"
        if sync_file "$src" "$dst" "config"; then
            ((count++)) || true
        fi
    fi

    if [[ $count -gt 0 ]]; then
        log "  ${BOLD}$count${NC} config file(s) synced"
    fi
}

show_list() {
    log "${BOLD}Available extensions:${NC}"
    local extensions
    mapfile -t extensions < <(list_extensions)
    if [[ ${#extensions[@]} -eq 0 ]]; then
        log "  (none)"
    else
        for ext in "${extensions[@]}"; do
            log "  - $ext"
        done
    fi

    echo

    log "${BOLD}Available skills:${NC}"
    local skills
    mapfile -t skills < <(list_skills)
    if [[ ${#skills[@]} -eq 0 ]]; then
        log "  (none)"
    else
        for skill in "${skills[@]}"; do
            log "  - $skill"
        done
    fi

    echo

    log "${BOLD}Available config:${NC}"
    local pi_dir="$SKILLZ_DIR/pi"
    local has_config=false
    if [[ -f "$pi_dir/AGENTS.md" ]]; then
        log "  - AGENTS.md"
        has_config=true
    fi
    if [[ -f "$pi_dir/SYSTEM.md" ]]; then
        log "  - SYSTEM.md"
        has_config=true
    fi
    if [[ "$has_config" == false ]]; then
        log "  (none)"
    fi
}

show_status() {
    log "${BOLD}Synced extensions:${NC} ($PI_AGENT_DIR/extensions/)"
    if [[ -d "$PI_AGENT_DIR/extensions" ]]; then
        local found=false
        for file in "$PI_AGENT_DIR/extensions"/*.ts; do
            [[ -e "$file" ]] || continue
            # Skip .d.ts files
            [[ "$file" == *.d.ts ]] && continue
            found=true
            local name
            name="$(basename "$file")"
            if [[ -L "$file" ]]; then
                local target
                target="$(readlink "$file")"
                log "  ${GREEN}$name${NC} -> $target"
            else
                log "  ${BLUE}$name${NC} (copied)"
            fi
        done
        if [[ "$found" == false ]]; then
            log "  (none)"
        fi
    else
        log "  (directory not found)"
    fi

    echo

    log "${BOLD}Synced skills:${NC} ($PI_AGENT_DIR/skills/)"
    if [[ -d "$PI_AGENT_DIR/skills" ]]; then
        local found=false
        for dir in "$PI_AGENT_DIR/skills"/*/; do
            [[ -d "$dir" ]] || continue
            found=true
            local name
            name="$(basename "$dir")"
            if [[ -L "${dir%/}" ]]; then
                local target
                target="$(readlink "${dir%/}")"
                log "  ${GREEN}$name${NC} -> $target"
            else
                log "  ${BLUE}$name${NC} (copied)"
            fi
        done
        if [[ "$found" == false ]]; then
            log "  (none)"
        fi
    else
        log "  (directory not found)"
    fi

    echo

    log "${BOLD}Synced config:${NC} ($PI_AGENT_DIR/)"
    local has_config=false
    for config_file in AGENTS.md SYSTEM.md; do
        local file="$PI_AGENT_DIR/$config_file"
        if [[ -e "$file" || -L "$file" ]]; then
            has_config=true
            if [[ -L "$file" ]]; then
                local target
                target="$(readlink "$file")"
                log "  ${GREEN}$config_file${NC} -> $target"
            else
                log "  ${BLUE}$config_file${NC} (copied)"
            fi
        fi
    done
    if [[ "$has_config" == false ]]; then
        log "  (none)"
    fi
}

show_help() {
    cat << 'EOF'
pi-sync - Sync skillz repository to ~/.pi/agent/

Usage:
  pi-sync [OPTIONS] [COMMAND] [ITEMS...]

Commands:
  extensions [NAMES...]  Sync extensions (all if no names given)
  skills [NAMES...]      Sync skills (all if no names given)
  config                 Sync config files (AGENTS.md, SYSTEM.md from pi/)
  all                    Sync everything (extensions, skills, config)
  list                   List available extensions, skills, and config
  status                 Show what's currently synced

Options:
  -c, --copy      Copy files instead of symlinking (default: symlink)
  -f, --force     Overwrite existing files
  -n, --dry-run   Show what would be done without doing it
  -q, --quiet     Suppress output
  -h, --help      Show this help

Environment:
  SKILLZ_DIR      Path to skillz repository (default: auto-detect)
  PI_AGENT_DIR    Path to pi agent config (default: ~/.pi/agent)

Examples:
  pi-sync all                    # Sync extensions, skills, and config
  pi-sync extensions             # Sync all extensions
  pi-sync skills pexpect-cli     # Sync specific skill
  pi-sync config                 # Sync AGENTS.md and SYSTEM.md
  pi-sync --copy all             # Copy instead of symlink
  pi-sync status                 # Show current state
EOF
}

# ─── Main ─────────────────────────────────────────────────────────────────────

main() {
    local command=""
    local items=()

    # Parse arguments
    while [[ $# -gt 0 ]]; do
        case "$1" in
            -c|--copy)
                USE_SYMLINK=false
                shift
                ;;
            -f|--force)
                FORCE=true
                shift
                ;;
            -n|--dry-run)
                DRY_RUN=true
                shift
                ;;
            -q|--quiet)
                QUIET=true
                shift
                ;;
            -h|--help)
                show_help
                exit 0
                ;;
            extensions|skills|config|all|list|status)
                command="$1"
                shift
                ;;
            -*)
                die "unknown option: $1"
                ;;
            *)
                items+=("$1")
                shift
                ;;
        esac
    done

    # Validate
    if [[ ! -d "$SKILLZ_DIR" ]]; then
        die "skillz directory not found: $SKILLZ_DIR"
    fi

    if [[ -z "$command" ]]; then
        show_help
        exit 1
    fi

    # Execute command
    case "$command" in
        extensions)
            sync_extensions "${items[@]}"
            ;;
        skills)
            sync_skills "${items[@]}"
            ;;
        config)
            sync_config
            ;;
        all)
            sync_extensions
            echo
            sync_skills
            echo
            sync_config
            ;;
        list)
            show_list
            ;;
        status)
            show_status
            ;;
    esac
}

main "$@"
